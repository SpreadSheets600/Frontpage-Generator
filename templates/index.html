{% extends "layout.html" %} {% block content %}
<div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-16 items-center min-h-[80vh]">
  <!-- Left: Content -->
  <div class="space-y-8 reveal text-center lg:text-left">
    <div
      class="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-electric/30 bg-electric/10 text-electric font-mono text-xs">
      <span class="relative flex h-2 w-2">
        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-electric opacity-75"></span>
        <span class="relative inline-flex rounded-full h-2 w-2 bg-electric"></span>
      </span>
      SYSTEM ONLINE
    </div>

    <h1 class="text-5xl sm:text-6xl md:text-8xl font-bold tracking-tighter leading-[0.9]">
      GENERATE <br />
      <span class="text-transparent bg-clip-text bg-gradient-to-r from-electric to-cyber">FRONTPAGES</span>
    </h1>

    <p class="text-lg sm:text-xl text-white/60 font-light max-w-md leading-relaxed mx-auto lg:mx-0">Automated frontpage
      generation for academic submissions. Precision engineered templates. Instant delivery.</p>

    <div class="flex flex-col sm:flex-row gap-4 pt-4 items-center lg:items-start justify-center lg:justify-start">
      <div class="flex -space-x-4">
        <div
          class="w-12 h-12 rounded-full border-2 border-obsidian bg-white/10 backdrop-blur flex items-center justify-center text-xs font-mono">
          SM</div>
        <div
          class="w-12 h-12 rounded-full border-2 border-obsidian bg-white/10 backdrop-blur flex items-center justify-center text-xs font-mono">
          UP</div>
        <div
          class="w-12 h-12 rounded-full border-2 border-obsidian bg-white/10 backdrop-blur flex items-center justify-center text-xs font-mono">
          GY</div>
      </div>
      <div class="flex flex-col justify-center text-center sm:text-left">
        <span class="text-sm font-bold"><span id="docCounter" data-min="108" data-max="182"
            data-interval="2300">100</span>+ Generated</span>
        <span class="text-xs text-white/40 font-mono">Trusted By Students</span>
      </div>
    </div>
  </div>

  <!-- Right: Form -->
  <div class="relative reveal" style="transition-delay: 200ms">

    <div class="glass p-6 md:p-10 rounded-3xl relative overflow-hidden">

      <h2 class="text-2xl font-bold mb-8 flex items-center gap-3">
        <svg class="w-6 h-6 text-electric" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
          </path>
        </svg>
        INPUT PARAMETERS
      </h2>

      <form action="/frontpages" method="POST" class="space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="space-y-2">
            <label class="text-xs font-mono text-white/50 uppercase tracking-wider">Full Name</label>
            <input type="text" name="name" required
              class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-white/20 focus:outline-none focus:border-electric focus:ring-1 focus:ring-electric transition-all"
              placeholder="John Doe" />
          </div>
          <div class="space-y-2">
            <label class="text-xs font-mono text-white/50 uppercase tracking-wider">Roll Number</label>
            <input type="text" name="roll" required
              class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-white/20 focus:outline-none focus:border-electric focus:ring-1 focus:ring-electric transition-all"
              placeholder="123456" />
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="space-y-2">
            <label class="text-xs font-mono text-white/50 uppercase tracking-wider">Registration No</label>
            <input type="text" name="reg" required
              class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-white/20 focus:outline-none focus:border-electric focus:ring-1 focus:ring-electric transition-all"
              placeholder="A-1234" />
          </div>
          <div class="space-y-2">
            <label class="text-xs font-mono text-white/50 uppercase tracking-wider">Semester</label>
            <select name="semester_id" id="semesterSelect" required
              class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-electric focus:ring-1 focus:ring-electric transition-all appearance-none">
              <option value="" disabled selected>Select Semester</option>
              {% for sem in semesters %}
              <option value="{{ sem.id }}" class="bg-obsidian">{{ sem.label }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="space-y-2">
          <label class="text-xs font-mono text-white/50 uppercase tracking-wider">Stream</label>
          <select name="stream_id" id="streamSelect" required disabled
            class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-electric focus:ring-1 focus:ring-electric transition-all appearance-none">
            <option value="" disabled selected>Select Stream</option>
          </select>
        </div>

        <div class="space-y-2">
          <label class="text-xs font-mono text-white/50 uppercase tracking-wider">Subject</label>
          <select name="subject_id" id="subjectSelect" required disabled
            class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-electric focus:ring-1 focus:ring-electric transition-all appearance-none">
            <option value="" disabled selected>Select Subject</option>
            <!-- Populated by JS -->
          </select>
        </div>

        <div class="flex items-center justify-between gap-4 bg-white/5 border border-white/10 rounded-xl px-4 py-3">
          <div>
            <p class="text-sm font-semibold text-white">Download as PDF</p>
            <p class="text-xs text-white/50">Toggle to receive the generated frontpage in PDF format.</p>
          </div>
          <label class="relative inline-flex cursor-pointer items-center">
            <input type="checkbox" name="as_pdf" class="sr-only peer">
            <div
              class="w-12 h-6 bg-white/20 rounded-full peer peer-focus:ring-2 peer-focus:ring-electric peer-checked:bg-electric after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:bg-white after:h-5 after:w-5 after:rounded-full after:transition-all peer-checked:after:translate-x-6">
            </div>
          </label>
        </div>

        <button type="submit"
          class="group w-full bg-white text-black font-bold py-4 rounded-xl mt-4 hover:bg-electric hover:text-white transition-all duration-300 relative overflow-hidden">
          <span class="relative z-10 flex items-center justify-center gap-2">
            GENERATE DOCUMENT
            <svg class="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor"
              viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
            </svg>
          </span>
        </button>

        <a href="{{ url_for('download_index_page') }}"
          class="w-full inline-flex items-center justify-center gap-2 bg-transparent border border-white/20 text-white font-semibold py-3 rounded-xl hover:border-electric hover:text-electric transition-colors">
          INDEX PAGE
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
            stroke="currentColor" class="size-6">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M2.25 18 9 11.25l4.306 4.306a11.95 11.95 0 0 1 5.814-5.518l2.74-1.22m0 0-5.94-2.281m5.94 2.28-2.28 5.941" />
          </svg>
        </a>
      </form>
    </div>
  </div>
</div>

<script type="application/json" id="catalogData">{{ (catalog or [])|tojson|safe }}</script>
<script type="application/json" id="streamsData">{{ (streams or [])|tojson|safe }}</script>
<script>
  const catalogJson = document.getElementById('catalogData');
  const catalog = catalogJson ? JSON.parse(catalogJson.textContent || '[]') : [];
  const streamsJson = document.getElementById('streamsData');
  const streams = streamsJson ? JSON.parse(streamsJson.textContent || '[]') : [];
  const semesterSelect = document.getElementById('semesterSelect');
  const streamSelect = document.getElementById('streamSelect');
  const subjectSelect = document.getElementById('subjectSelect');

  const catalogMap = {};
  catalog.forEach(entry => {
    catalogMap[String(entry.semester.id)] = (entry.subjects || []).map(subject => ({
      id: String(subject.subject_id),
      name: subject.name,
      code: subject.code
    }));
  });

  function resetSelect(selectEl, placeholder) {
    selectEl.innerHTML = `<option value="" disabled selected>${placeholder}</option>`;
    selectEl.disabled = true;
  }

  function populateSelect(selectEl, placeholder, items, formatter) {
    resetSelect(selectEl, placeholder);
    if (!items || !items.length) {
      return;
    }
    items.forEach(item => {
      const option = document.createElement('option');
      option.value = item.id;
      option.textContent = formatter(item);
      option.className = 'bg-obsidian';
      selectEl.appendChild(option);
    });
    selectEl.disabled = false;
  }

  function populateStreams() {
    populateSelect(streamSelect, 'Select Stream', streams, (item) => item.name);
  }

  populateStreams();

  semesterSelect.addEventListener('change', (event) => {
    const selectedSemester = event.target.value;
    const subjects = catalogMap[selectedSemester] || [];
    populateSelect(subjectSelect, 'Select Subject', subjects, (item) => `${item.name} (${item.code})`);
  });

  const docCounterEl = document.getElementById('docCounter');
  if (docCounterEl) {
    async function updateCounter() {
      try {
        const res = await fetch('/api/stats');
        if (res.ok) {
          const data = await res.json();
          docCounterEl.textContent = data.generated_count;
        }
      } catch (e) {
        console.error('Failed to fetch stats', e);
      }
    }

    updateCounter();
    setInterval(updateCounter, 30000);
  }
</script>
{% endblock %}
